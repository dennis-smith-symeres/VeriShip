@page "/{projectNumber}/certifications"
@using Ardalis.Result
@using Humanizer
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Telerik.Windows.Documents.Spreadsheet.Expressions.Functions
@using VeriShip.Application.Features.Signals
@using VeriShip.Application.Features.Signals.Models
@using VeriShip.Application.Features.Signals.Queries
@using VeriShip.WebApp.Constants

<PageTitle>@ProjectNumber Certifications</PageTitle>

@if (NotebookResult.IsSuccess)
{
    <div>
        show requests
    </div>
    <div>
        show shipments
    </div>
}
@if (NotebookResult.IsUnavailable())
{
    <TelerikLoader></TelerikLoader>
}
@if (!NotebookResult.IsSuccess && !NotebookResult.IsUnavailable())
{
    <h2>
        Journal @ProjectNumber
    </h2>
    <p>
        @NotebookResult.Status.Humanize()
    </p>
}

@code {

    [Parameter] public string ProjectNumber { get; set; } = string.Empty;
    [CascadingParameter] private Task<AuthenticationState>? AuthState { get; set; }
    [Inject] public required ISignalsStore SignalsStore { get; set; }
    [Inject] public required ProtectedLocalStorage LocalStorage { get; set; }

    private Result<Notebook> NotebookResult { get; set; } = Result.Unavailable();

    protected override async Task OnParametersSetAsync()
    {
        if (AuthState != null)
        {
            var authState = await AuthState;

            NotebookResult = await SignalsStore.Query(new GetNotebook(ProjectNumber, authState.User));
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (NotebookResult is { IsSuccess: true, Value.CanRead: true })
        {
            List<string> notebooks = [];
            try
            {
                var storedNotebooks = await LocalStorage.GetAsync<List<string>>(LocalStorageKeys.VerishipNotebooks);
                notebooks = storedNotebooks.Success ? storedNotebooks.Value : [];
            }
            catch (Exception e)
            {
                Console.WriteLine(e);
            }

            if (notebooks.Contains(ProjectNumber))
            {
                notebooks.Remove(ProjectNumber);
            }

            notebooks.Insert(0, ProjectNumber);
            notebooks = notebooks.Take(5).ToList();

            await LocalStorage.SetAsync(LocalStorageKeys.VerishipNotebooks, notebooks);
        }
    }


}